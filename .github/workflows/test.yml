name: TDR Run API tests
on:
  pull_request:
  push:
    branches-ignore:
      - main
      - release-*
permissions:
  id-token: write
  contents: write
  actions: write
  packages: read
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.get-packages.outputs.packages }}
    steps:
      - uses: actions/checkout@v2
      - id: get-packages
        run: echo ::set-output name=packages::$((cd src/test/scala ; find uk/gov/nationalarchives/tdr/api/* -type d -links 2 ! -empty | sed 's/\//./g') | jq -R -s -c 'split("\n")[:-1]')
  test:
    runs-on: ubuntu-latest
    needs:
      - get-packages
    strategy:
      matrix:
        package: ${{ fromJSON(needs.setup.outputs.packages) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: coursier/cache-action@v6
      - name: Configure AWS credentials from management account
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::${{ secrets.MANAGEMENT_ACCOUNT }}:role/TDRGithubActionsRoleMgmt
          aws-region: eu-west-2
          role-session-name: APIDownloadDependencies
      - name: Test
        run: |
          docker build -f Dockerfile-test -t tests .
          sbt "testOnly ${{ matrix.package }}*" scalastyle test:scalastyle 'graphqlValidateSchema "build" "consignmentApi"'
