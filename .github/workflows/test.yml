name: TDR Run API tests
on:
  pull_request:
  push:
    branches-ignore:
      - master
      - release-*
permissions:
  id-token: write
  contents: read
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: sbt/setup-sbt@f20dc1bc1f8be605c44ffbcec6f17f708a4af9d1
      - run: sbt scalafmtCheckAll 'graphqlValidateSchema "build" "consignmentApi"'
        env:
          AKKA_TOKEN: ${{ secrets.AKKA_TOKEN }}
  setup-tests:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.generate-files.outputs.files }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: sbt/setup-sbt@f20dc1bc1f8be605c44ffbcec6f17f708a4af9d1
      - id: generate-files
        run: |
          FILES=$(find src/test/* -name "*Spec.scala" -type f -printf "%f\n" | sed 's/\.[^.]*$//' | jq -R -s -c 'split("\n")[:-1]')
          echo files=${FILES} >> $GITHUB_OUTPUT
  test:
    runs-on: ubuntu-latest
    needs: setup-tests
    strategy:
      matrix:
        file: ${{ fromJSON(needs.setup-tests.outputs.files) }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: sbt/setup-sbt@f20dc1bc1f8be605c44ffbcec6f17f708a4af9d1
      - run: |
          docker build -f Dockerfile-tests -t tests .
          sbt 'testOnly *${{ matrix.file }}*'
        env:
          AKKA_TOKEN: ${{ secrets.AKKA_TOKEN }}
