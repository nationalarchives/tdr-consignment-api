name: TDR Run API tests
on:
  pull_request:
  push:
    branches-ignore:
      - master
      - release-*
permissions:
  id-token: write
  contents: read
jobs:
  setup-tests:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.generate-files.outputs.files }}
    steps:
      - uses: actions/checkout@v3
      - id: generate-files
        run: |
          FILES=$(find src/test/* -name "*Spec.scala" -type f -printf "%f\n" | sed 's/\.[^.]*$//' | jq -R -s -c 'split("\n")[:-1]')
          echo ::set-output name=files::${FILES}
  test:
    runs-on: ubuntu-latest
    needs: setup-tests
    strategy:
      matrix:
        file: ${{ fromJSON(needs.setup-tests.outputs.files) }}
    steps:
      - uses: actions/checkout@v3
      - run: |
          docker build -f Dockerfile-tests -t tests .
          sbt testOnly *${{ matrix.file }}*
  validate:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      - run: sbt scalastyle test:scalastyle 'graphqlValidateSchema "build" "consignmentApi"'
